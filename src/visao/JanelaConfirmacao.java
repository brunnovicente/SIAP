/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package visao;

import controle.FachadaControle;
import java.awt.event.KeyEvent;
import java.sql.SQLException;
import java.text.DecimalFormat;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.JOptionPane;
import persistencia.entidades.Venda;

/**
 *
 * @author Bruno
 */
public class JanelaConfirmacao extends javax.swing.JDialog {

    private double valororiginal;
    private Venda vendaTemp;
    private java.awt.Frame pai;
    private Venda venda;
    private boolean bloqueado = false;

    /**
     * Creates new form JanelaConfirmacao
     */
    public JanelaConfirmacao(java.awt.Frame parent, boolean modal, Venda venda) {
        super(parent, modal);
        initComponents();
        pai = parent;
        this.setLocationRelativeTo(null);
        jvendedor.setText(venda.getVendedor().getNome());
        jtotal.setText("R$" + venda.getTotal()+"");
        valororiginal = venda.getTotal();
        
        jpagamento.addItem(Venda.DINHEIRO);
        jpagamento.addItem(Venda.CARTAO);
        jpagamento.requestFocus();
        
        jimprimir.setEnabled(false);
        
        this.venda = venda;
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        buttonGroup1 = new javax.swing.ButtonGroup();
        jPanel1 = new javax.swing.JPanel();
        jLabel2 = new javax.swing.JLabel();
        jLabel4 = new javax.swing.JLabel();
        jLabel5 = new javax.swing.JLabel();
        jLabel6 = new javax.swing.JLabel();
        jvendedor = new javax.swing.JTextField();
        jtotal = new javax.swing.JTextField();
        jvalor = new javax.swing.JTextField();
        jtroco = new javax.swing.JTextField();
        jLabel1 = new javax.swing.JLabel();
        jpagamento = new javax.swing.JComboBox();
        jButton1 = new javax.swing.JButton();
        jimprimir = new javax.swing.JButton();
        jconfirmar = new javax.swing.JButton();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        setTitle("CONCLUIR A VENDA");
        setResizable(false);

        jPanel1.setBorder(javax.swing.BorderFactory.createTitledBorder("Dados da Venda"));

        jLabel2.setFont(new java.awt.Font("Tahoma", 0, 14)); // NOI18N
        jLabel2.setText("TOTAL DA VENDA:");

        jLabel4.setFont(new java.awt.Font("Tahoma", 0, 14)); // NOI18N
        jLabel4.setText("VALOR PAGO:");

        jLabel5.setFont(new java.awt.Font("Tahoma", 0, 14)); // NOI18N
        jLabel5.setText("TROCO:");

        jLabel6.setFont(new java.awt.Font("Tahoma", 0, 14)); // NOI18N
        jLabel6.setText("VENDEDOR:");

        jvendedor.setEditable(false);
        jvendedor.setFont(new java.awt.Font("Tahoma", 0, 18)); // NOI18N

        jtotal.setEditable(false);
        jtotal.setFont(new java.awt.Font("Tahoma", 0, 18)); // NOI18N

        jvalor.setFont(new java.awt.Font("Tahoma", 0, 18)); // NOI18N
        jvalor.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                jvalorMouseClicked(evt);
            }
        });
        jvalor.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jvalorActionPerformed(evt);
            }
        });
        jvalor.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                jvalorKeyPressed(evt);
            }
        });

        jtroco.setEditable(false);
        jtroco.setFont(new java.awt.Font("Tahoma", 0, 18)); // NOI18N
        jtroco.setText("0");

        jLabel1.setFont(new java.awt.Font("Tahoma", 0, 14)); // NOI18N
        jLabel1.setText("FORMA DE PAGAMENTO:");

        jpagamento.setFont(new java.awt.Font("Tahoma", 0, 18)); // NOI18N
        jpagamento.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                jpagamentoKeyPressed(evt);
            }
        });

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addGap(21, 21, 21)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                    .addComponent(jLabel6)
                    .addComponent(jLabel2)
                    .addComponent(jLabel1))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jvendedor)
                    .addComponent(jpagamento, 0, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addComponent(jtotal, javax.swing.GroupLayout.PREFERRED_SIZE, 197, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(0, 126, Short.MAX_VALUE)))
                .addContainerGap())
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addGap(87, 87, 87)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                    .addComponent(jLabel4)
                    .addComponent(jLabel5))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING, false)
                    .addComponent(jtroco, javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jvalor, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.PREFERRED_SIZE, 169, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel6)
                    .addComponent(jvendedor, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(18, 18, 18)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel2)
                    .addComponent(jtotal, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(18, 18, 18)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel1)
                    .addComponent(jpagamento, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(18, 18, 18)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel4)
                    .addComponent(jvalor, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(18, 18, 18)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jtroco, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jLabel5))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        jButton1.setIcon(new javax.swing.ImageIcon(getClass().getResource("/imagens/excluir.png"))); // NOI18N
        jButton1.setText("FECHAR");
        jButton1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton1ActionPerformed(evt);
            }
        });

        jimprimir.setIcon(new javax.swing.ImageIcon(getClass().getResource("/imagens/imprimir.png"))); // NOI18N
        jimprimir.setText("NOTA");
        jimprimir.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jimprimirActionPerformed(evt);
            }
        });

        jconfirmar.setIcon(new javax.swing.ImageIcon(getClass().getResource("/imagens/ok.png"))); // NOI18N
        jconfirmar.setText("Confirmar");
        jconfirmar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jconfirmarActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addGroup(layout.createSequentialGroup()
                        .addGap(0, 0, Short.MAX_VALUE)
                        .addComponent(jimprimir, javax.swing.GroupLayout.PREFERRED_SIZE, 128, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jconfirmar, javax.swing.GroupLayout.PREFERRED_SIZE, 129, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jButton1, javax.swing.GroupLayout.PREFERRED_SIZE, 135, javax.swing.GroupLayout.PREFERRED_SIZE)))
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addComponent(jButton1)
                    .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(jconfirmar, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addComponent(jimprimir)))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void jButton1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton1ActionPerformed
        this.dispose();       // TODO add your handling code here:
    }//GEN-LAST:event_jButton1ActionPerformed

    private void jvalorKeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_jvalorKeyPressed
        if(evt.getKeyCode() == KeyEvent.VK_ENTER){
            try{
                if(!bloqueado){
                    //this.confirmaVenda();
                    double pago = Double.parseDouble(this.jvalor.getText().replaceAll(",", "."));
                    double troco = pago - this.venda.getTotal();

                    jtroco.setText("R$ "+troco);
                    this.confirmaVenda();
                }
            }catch(Exception ex){
                if(ex.getMessage().contains("could not execute statement")){
                    JOptionPane.showMessageDialog(null, "Foi inserido um valor inválido.");
                    jvalor.requestFocus();
                    jvalor.selectAll();
                }
            }
        }//else {
            if(evt.getKeyCode() == KeyEvent.VK_ESCAPE){
                this.dispose();
           } if(evt.getKeyCode() == KeyEvent.VK_F3){
                try {
                    FachadaControle.getFachadaControle().gerarRelatorioOrcamento(this.venda);
                    //JanelaGerandoRelatorio janela_gerando = new JanelaGerandoRelatorio(pai, this.vendaTemp, true);
                    //janela_gerando.setVisible(true);
                } catch (Exception ex) {
                    Logger.getLogger(JanelaConfirmacao.class.getName()).log(Level.SEVERE, null, ex);
                }
           }
    }//GEN-LAST:event_jvalorKeyPressed

    private void jvalorActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jvalorActionPerformed

    }//GEN-LAST:event_jvalorActionPerformed

    private void jpagamentoKeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_jpagamentoKeyPressed
        if(evt.getKeyCode() == KeyEvent.VK_ENTER){
            jvalor.requestFocus();
        }else {
            if(evt.getKeyCode() == KeyEvent.VK_ESCAPE){
                this.dispose();
            }
        }
    }//GEN-LAST:event_jpagamentoKeyPressed

    private void jimprimirActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jimprimirActionPerformed
        try {
            FachadaControle.getFachadaControle().gerarRelatorioOrcamento(this.venda);
            //JanelaGerandoRelatorio janela_gerando = new JanelaGerandoRelatorio(pai, this.vendaTemp, true);
            //janela_gerando.setVisible(true);
        } catch (Exception ex) {
            Logger.getLogger(JanelaConfirmacao.class.getName()).log(Level.SEVERE, null, ex);
        }
        
        
    }//GEN-LAST:event_jimprimirActionPerformed

    private void jvalorMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_jvalorMouseClicked
        //this.calculaValores();   
    }//GEN-LAST:event_jvalorMouseClicked

    private void jconfirmarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jconfirmarActionPerformed
        this.confirmaVenda();
    }//GEN-LAST:event_jconfirmarActionPerformed
    
    
    public void confirmaVenda(){
        try {
            
                //CALCULA OS VALORES
                //Venda temp = this.venda.clone();
                
                //this.vendaTemp = this.venda;
                
                double valor_pago = Double.parseDouble(jvalor.getText().replaceAll(",", "."));
                
                double troco = valor_pago - this.venda.getTotal();
                
                if(troco < 0){
                    throw new Exception("Valor pago insuficiente!");
                }
                
                
                DecimalFormat df = new DecimalFormat("#,###.00");  
                
                if(troco == 0){
                    jtroco.setText("R$ 0,00");
                }else{
                    jtroco.setText("R$ "+df.format(troco));
                }
                
                jtotal.setText("R$ " + this.venda.getTotal());
                
                this.venda.setFormaPagamento((String)jpagamento.getSelectedItem());
                this.venda.setTotal(this.venda.getTotal());
                this.venda.setCaixa(FachadaControle.getFachadaControle().getCaixa());
                FachadaControle.getFachadaControle().efetuarVenda(venda);
                //this.vendaTemp = temp;
                //JOptionPane.showMessageDialog(null, "Venda efetuada com sucesso!");
                ConfirmaDialogo dialogo = new ConfirmaDialogo(pai, true);
                dialogo.setVisible(true);
                
                jvalor.setText(jvalor.getText().replaceAll(",", "."));
                jvalor.setEditable(false);
                
                //this.dispose();
                jconfirmar.setEnabled(false);
                jimprimir.setEnabled(true);
                
//                try {
//                    FachadaControle.getFachadaControle().gerarRelatorioOrcamento(this.venda);
//                    //JanelaGerandoRelatorio janela_gerando = new JanelaGerandoRelatorio(pai, this.vendaTemp, true);
//                    //janela_gerando.setVisible(true);
//                    this.dispose();
//                } catch (Exception ex) {
//                    Logger.getLogger(JanelaConfirmacao.class.getName()).log(Level.SEVERE, null, ex);
//                }
                bloqueado = true;
            } catch (SQLException ex) {
                JOptionPane.showMessageDialog(null, ex.getMessage());
            } catch (Exception ex){
                ex.printStackTrace();
                if(ex.getMessage().contains("empty")){
                    //JOptionPane.showMessageDialog(null, "Digite todos os valores!");
                    ErroDialogo dialogo = new ErroDialogo(pai, true, "Digite todos os valores!");
                    dialogo.setVisible(true);
                }else{
                    if(ex.getMessage().contains("For input string")){
                        //JOptionPane.showMessageDialog(null, "Valor Pago inválido!");
                        ErroDialogo dialogo = new ErroDialogo(pai, true, "Valor pago inválido!");
                        dialogo.setVisible(true);
                    }else{
                        ex.printStackTrace();
                        //JOptionPane.showMessageDialog(null, ex.getMessage());
                        ErroDialogo dialogo = new ErroDialogo(pai, true, ex.getMessage());
                        dialogo.setVisible(true);
                    }
                }
            }
    }
    
    private double calcularPorcentagem(double total, double por){
        double x = (por * total) / 100;
        return x;
    }
    
    /**
     * @param args the command line arguments
     */
//    public static void main(String args[]) {
//        /*
//         * Set the Nimbus look and feel
//         */
//        //<editor-fold defaultstate="collapsed" desc=" Look and feel setting code (optional) ">
//        /*
//         * If Nimbus (introduced in Java SE 6) is not available, stay with the
//         * default look and feel. For details see
//         * http://download.oracle.com/javase/tutorial/uiswing/lookandfeel/plaf.html
//         */
//        try {
//            for (javax.swing.UIManager.LookAndFeelInfo info : javax.swing.UIManager.getInstalledLookAndFeels()) {
//                if ("Nimbus".equals(info.getName())) {
//                    javax.swing.UIManager.setLookAndFeel(info.getClassName());
//                    break;
//                }
//            }
//        } catch (ClassNotFoundException ex) {
//            java.util.logging.Logger.getLogger(JanelaConfirmacao.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
//        } catch (InstantiationException ex) {
//            java.util.logging.Logger.getLogger(JanelaConfirmacao.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
//        } catch (IllegalAccessException ex) {
//            java.util.logging.Logger.getLogger(JanelaConfirmacao.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
//        } catch (javax.swing.UnsupportedLookAndFeelException ex) {
//            java.util.logging.Logger.getLogger(JanelaConfirmacao.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
//        }
//        //</editor-fold>
//
//        /*
//         * Create and display the dialog
//         */
//        java.awt.EventQueue.invokeLater(new Runnable() {
//
//            public void run() {
//                JanelaConfirmacao dialog = new JanelaConfirmacao(new javax.swing.JFrame(), true);
//                dialog.addWindowListener(new java.awt.event.WindowAdapter() {
//
//                    @Override
//                    public void windowClosing(java.awt.event.WindowEvent e) {
//                        System.exit(0);
//                    }
//                });
//                dialog.setVisible(true);
//            }
//        });
//    }
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.ButtonGroup buttonGroup1;
    private javax.swing.JButton jButton1;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JLabel jLabel6;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JButton jconfirmar;
    private javax.swing.JButton jimprimir;
    private javax.swing.JComboBox jpagamento;
    private javax.swing.JTextField jtotal;
    private javax.swing.JTextField jtroco;
    private javax.swing.JTextField jvalor;
    private javax.swing.JTextField jvendedor;
    // End of variables declaration//GEN-END:variables
}
